// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuthProvider {
  EMAIL
  GITHUB
  GOOGLE
}

enum ProjectVisibility {
  PRIVATE
  PUBLIC
}

enum BranchPushMode {
  AUTO
  MANUAL
  NONE
}

enum DriveSyncMode {
  OFF
  AUTO
  MANUAL
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum RunStatus {
  PENDING
  RUNNING
  SUCCESS
  ERROR
  TIMEOUT
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  name          String
  avatar        String?
  passwordHash  String?       // null for OAuth users
  authProviders Json          @default("[]") // Array of AuthProvider
  githubToken   String?       // Should be encrypted at application level
  githubUsername String?
  googleToken   String?       // Should be encrypted at application level
  googleRefreshToken String?  // Should be encrypted at application level
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  createdTeams  Team[]        @relation("TeamLeader")
  teamMemberships TeamMember[]
  createdProjects Project[]   @relation("ProjectCreator")
  sessions      Session[]
  runs          Run[]
  tasks         Task[]
  comments      Comment[]
  computeJobs   ComputeJob[]
  credits       ComputeCredits?
  codeTemplates CodeTemplate[] @relation("CodeTemplates")
  codeSnippets  CodeSnippet[] @relation("CodeSnippets")
  codeReviews   CodeReview[] @relation("CodeReviews")

  @@index([email])
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  leaderId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  leader      User     @relation("TeamLeader", fields: [leaderId], references: [id], onDelete: Cascade)
  members     TeamMember[]
  projects    Project[]

  @@index([leaderId])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String   @default("member") // "member" | "senior"
  pushMode  BranchPushMode @default(MANUAL)
  createdAt DateTime @default(now())

  // Relations
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Project {
  id              String          @id @default(cuid())
  name            String
  description     String?
  projectType     String?         // "react", "flutter", "nodejs", "android", "ios", etc.
  tags            String[]        @default([])
  languages       String[]        @default([])
  visibility      ProjectVisibility @default(PRIVATE)
  ownerTeamId     String
  createdBy       String
  roomId          String          @unique // Unique room identifier
  settings        Json            @default("{}") // { autoPush, autoBranching, compileDefaults, etc. }
  githubRepoName  String?
  githubRepoUrl   String?
  githubRepoId    String?
  driveFolderId   String?
  driveSyncMode   DriveSyncMode   @default(OFF)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  ownerTeam       Team            @relation(fields: [ownerTeamId], references: [id], onDelete: Cascade)
  creator         User            @relation("ProjectCreator", fields: [createdBy], references: [id])
  files           File[]
  branches        Branch[]
  sessions        Session[]
  runs            Run[]
  tasks           Task[]
  comments        Comment[]
  computeJobs     ComputeJob[]
  academicIntegrity AcademicIntegrity?
  sessionRecordings SessionRecording[]
  codeReviews     CodeReview[]
  codeMetrics     CodeMetric[]
  shareLinks      ShareLink[]

  @@index([ownerTeamId])
  @@index([createdBy])
  @@index([roomId])
}

model File {
  id          String   @id @default(cuid())
  projectId   String
  path        String   // e.g., "src/main.js" or "README.md"
  content     String   @default("")
  isDirectory Boolean  @default(false)
  parentId    String?  // For folder hierarchy
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, path])
  @@index([projectId])
  @@index([parentId])
}

model Branch {
  id              String   @id @default(cuid())
  projectId       String
  name            String   // e.g., "main", "member/john", "feature/auth"
  gitBranchName   String?  // Actual Git branch name
  lastSyncAt      DateTime?
  aheadCount      Int      @default(0)
  behindCount     Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@index([projectId])
}

model Session {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  activeFile  String?  // Current file path
  cursorPos   Json?    // { line, column }
  joinedAt    DateTime @default(now())
  lastActive  DateTime @updatedAt

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Run {
  id          String    @id @default(cuid())
  projectId   String
  userId      String
  language    String
  version     String?
  code        String
  stdin       String?   @default("")
  status      RunStatus @default(PENDING)
  output      String?
  error       String?
  timeMs      Int?
  memoryKb    Int?
  createdAt   DateTime  @default(now())

  // Relations
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([createdAt])
}

model Task {
  id          String     @id @default(cuid())
  projectId   String
  title       String
  description String?
  assigneeId  String?
  status      TaskStatus  @default(TODO)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee    User?       @relation(fields: [assigneeId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([assigneeId])
}

model Comment {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  filePath    String?  // null for project-level comments
  line        Int?
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([filePath])
}

model SessionEvent {
  id          String   @id @default(cuid())
  projectId   String
  sessionId   String?  // Optional session identifier
  type        String   // "edit", "run", "chat", "join", "leave", etc.
  data        Json     // Event-specific data
  timestamp   DateTime @default(now())

  @@index([projectId])
  @@index([timestamp])
}

enum ComputeJobStatus {
  PENDING
  QUEUED
  SCHEDULED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum ComputeResourceType {
  CPU
  GPU
  MEMORY
}

enum CreditTransactionType {
  EARNED
  SPENT
  REFUNDED
  TRANSFERRED
  DONATED
}

model ComputeJob {
  id              String            @id @default(cuid())
  projectId       String
  userId          String
  jobType         String            // "code_execution", "ml_training", "data_processing"
  language        String
  code            String
  dockerImage     String?
  resourceType    ComputeResourceType @default(CPU)
  gpuType         String?           // "T4", "V100", "A100", etc.
  scheduledAt     DateTime?        // For calendar-based scheduling
  startedAt       DateTime?
  completedAt      DateTime?
  status          ComputeJobStatus  @default(PENDING)
  clusterId       String?           // Which cluster executed this
  institutionId   String?           // Which institution's cluster executed this
  nodeId          String?           // Which node executed this
  computeHours    Float             @default(0)
  creditsUsed     Float             @default(0)
  output          String?
  error           String?
  metadata        Json              @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  project         Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution     Institution?      @relation(fields: [institutionId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([userId])
  @@index([institutionId])
  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
}

model ComputeCredits {
  id              String                @id @default(cuid())
  userId          String?               // null for institutional credits
  institutionId   String?               // null for user credits
  balance         Float                 @default(0)
  totalEarned     Float                 @default(0)
  totalSpent      Float                 @default(0)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Relations
  user            User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution     Institution?          @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  transactions    CreditTransaction[]

  @@unique([userId])
  @@unique([institutionId])
  @@index([userId])
  @@index([institutionId])
}

model CreditTransaction {
  id              String                  @id @default(cuid())
  creditsId       String
  type            CreditTransactionType
  amount          Float
  description     String
  jobId           String?                 // If related to a compute job
  metadata        Json                    @default("{}")
  createdAt       DateTime                @default(now())

  // Relations
  credits         ComputeCredits          @relation(fields: [creditsId], references: [id], onDelete: Cascade)

  @@index([creditsId])
  @@index([type])
  @@index([createdAt])
}

model Institution {
  id              String          @id @default(cuid())
  name            String
  domain          String          @unique // e.g., "stanford.edu"
  type            String          // "university", "research_lab", "enterprise"
  clusterEndpoint String?         // GKE cluster endpoint
  gpuCount        Int             @default(0)
  gpuTypes        String[]        @default([])
  utilizationRate Float           @default(0) // 0-100
  revenueShare    Float           @default(0.70) // 70% default
  isActive        Boolean         @default(true)
  settings        Json            @default("{}")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  credits         ComputeCredits?
  jobs            ComputeJob[]
  gpuSchedules    GPUSchedule[] @relation("GPUSchedules")

  @@index([domain])
  @@index([isActive])
}

model GPUSchedule {
  id              String    @id @default(cuid())
  institutionId   String
  userId          String?   // null for maintenance windows
  startTime       DateTime
  endTime         DateTime
  gpuCount        Int
  gpuType         String?
  purpose         String    // "compute_job", "maintenance", "reserved"
  jobId           String?   // If linked to a compute job
  createdAt       DateTime  @default(now())

  // Relations
  institution     Institution @relation("GPUSchedules", fields: [institutionId], references: [id], onDelete: Cascade)

  @@index([institutionId])
  @@index([startTime])
  @@index([endTime])
  @@index([userId])
}

model AcademicIntegrity {
  id              String   @id @default(cuid())
  projectId       String
  examMode        Boolean  @default(false)
  plagiarismScore Float?   // 0-100, null if not checked
  activityLog     Json     @default("[]") // Detailed activity tracking
  lockDownUntil   DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId])
  @@index([examMode])
}

model SessionRecording {
  id              String   @id @default(cuid())
  projectId       String
  sessionName     String
  description     String?
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  duration        Int?     // in seconds
  events          Json     @default("[]") // All events: edits, runs, chat, etc.
  playbackData    Json?    // Processed playback data
  isPublic        Boolean  @default(false)
  shareToken      String   @unique
  viewCount       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([shareToken])
  @@index([isPublic])
}

model CodeTemplate {
  id              String   @id @default(cuid())
  name            String
  description     String?
  language        String
  code            String
  tags            String[] @default([])
  category        String   // "boilerplate", "algorithm", "data-structure", etc.
  isPublic        Boolean  @default(false)
  userId          String?  // null for system templates
  usageCount      Int      @default(0)
  rating          Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User?    @relation("CodeTemplates", fields: [userId], references: [id], onDelete: Cascade)

  @@index([language])
  @@index([category])
  @@index([isPublic])
  @@index([userId])
}

model CodeSnippet {
  id              String   @id @default(cuid())
  userId          String
  name            String
  code            String
  language        String
  tags            String[] @default([])
  isFavorite      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation("CodeSnippets", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([language])
  @@index([isFavorite])
}

model CodeReview {
  id              String   @id @default(cuid())
  projectId       String
  filePath        String
  reviewerId      String
  status          String   @default("PENDING") // PENDING, APPROVED, CHANGES_REQUESTED
  comments        Json     @default("[]") // Array of review comments
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewer        User     @relation("CodeReviews", fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([reviewerId])
  @@index([status])
}

model CodeMetric {
  id              String   @id @default(cuid())
  projectId       String
  filePath        String
  language        String
  linesOfCode     Int
  complexity      Float   // Cyclomatic complexity
  maintainability Float   // 0-100 score
  testCoverage    Float?  // 0-100 if available
  codeQuality     Float   // Overall quality score 0-100
  issues          Json     @default("[]") // Code issues found
  lastAnalyzed    DateTime @default(now())
  createdAt       DateTime @default(now())

  // Relations
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, filePath])
  @@index([projectId])
  @@index([codeQuality])
}

model ShareLink {
  id              String   @id @default(cuid())
  projectId       String?
  fileId          String?
  code            String?  // For standalone code snippets
  shortCode       String   @unique
  accessType      String   @default("READ_ONLY") // READ_ONLY, EDIT, FULL_ACCESS
  expiresAt       DateTime?
  viewCount       Int      @default(0)
  maxViews        Int?
  password        String?  // Should be encrypted at application level
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  project         Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([shortCode])
  @@index([projectId])
}

