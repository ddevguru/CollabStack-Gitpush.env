generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String          @id @default(cuid())
  email              String          @unique
  name               String
  avatar             String?
  passwordHash       String?
  authProviders      Json            @default("[]")
  githubToken        String?
  githubUsername     String?
  googleToken        String?
  googleRefreshToken String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  codeReviews        CodeReview[]    @relation("CodeReviews")
  codeSnippets       CodeSnippet[]   @relation("CodeSnippets")
  codeTemplates      CodeTemplate[]  @relation("CodeTemplates")
  comments           Comment[]
  credits            ComputeCredits?
  computeJobs        ComputeJob[]
  createdProjects    Project[]       @relation("ProjectCreator")
  runs               Run[]
  sessions           Session[]
  tasks              Task[]
  createdTeams       Team[]          @relation("TeamLeader")
  teamMemberships    TeamMember[]
  designs            Design[]

  @@index([email])
}

model Team {
  id          String       @id @default(cuid())
  name        String
  description String?
  leaderId    String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  projects    Project[]
  leader      User         @relation("TeamLeader", fields: [leaderId], references: [id], onDelete: Cascade)
  members     TeamMember[]

  @@index([leaderId])
}

model TeamMember {
  id        String         @id @default(cuid())
  teamId    String
  userId    String
  role      String         @default("member")
  pushMode  BranchPushMode @default(MANUAL)
  createdAt DateTime       @default(now())
  team      Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Project {
  id                String             @id @default(cuid())
  name              String
  description       String?
  tags              String[]           @default([])
  languages         String[]           @default([])
  visibility        ProjectVisibility  @default(PRIVATE)
  ownerTeamId       String
  createdBy         String
  roomId            String             @unique
  settings          Json               @default("{}")
  githubRepoName    String?
  githubRepoUrl     String?
  githubRepoId      String?
  driveFolderId     String?
  driveSyncMode     DriveSyncMode      @default(OFF)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  projectType       String?
  academicIntegrity AcademicIntegrity?
  branches          Branch[]
  codeMetrics       CodeMetric[]
  codeReviews       CodeReview[]
  comments          Comment[]
  computeJobs       ComputeJob[]
  files             File[]
  creator           User               @relation("ProjectCreator", fields: [createdBy], references: [id])
  ownerTeam         Team               @relation(fields: [ownerTeamId], references: [id], onDelete: Cascade)
  runs              Run[]
  sessions          Session[]
  sessionRecordings SessionRecording[]
  shareLinks        ShareLink[]
  tasks             Task[]
  designs           Design[]

  @@index([ownerTeamId])
  @@index([createdBy])
  @@index([roomId])
}

model File {
  id          String   @id @default(cuid())
  projectId   String
  path        String
  content     String   @default("")
  isDirectory Boolean  @default(false)
  parentId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, path])
  @@index([projectId])
  @@index([parentId])
}

model Design {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  name      String
  data      String   @default("[]")
  thumbnail String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([createdAt])
}

model Branch {
  id            String    @id @default(cuid())
  projectId     String
  name          String
  gitBranchName String?
  lastSyncAt    DateTime?
  aheadCount    Int       @default(0)
  behindCount   Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@index([projectId])
}

model Session {
  id         String   @id @default(cuid())
  projectId  String
  userId     String
  activeFile String?
  cursorPos  Json?
  joinedAt   DateTime @default(now())
  lastActive DateTime @updatedAt
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Run {
  id        String    @id @default(cuid())
  projectId String
  userId    String
  language  String
  version   String?
  code      String
  stdin     String?   @default("")
  status    RunStatus @default(PENDING)
  output    String?
  error     String?
  timeMs    Int?
  memoryKb  Int?
  createdAt DateTime  @default(now())
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([createdAt])
}

model Task {
  id          String     @id @default(cuid())
  projectId   String
  title       String
  description String?
  assigneeId  String?
  status      TaskStatus @default(TODO)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  assignee    User?      @relation(fields: [assigneeId], references: [id])
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([assigneeId])
}

model Comment {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  filePath  String?
  line      Int?
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([filePath])
}

model SessionEvent {
  id        String   @id @default(cuid())
  projectId String
  sessionId String?
  type      String
  data      Json
  timestamp DateTime @default(now())

  @@index([projectId])
  @@index([timestamp])
}

model ComputeJob {
  id            String              @id @default(cuid())
  projectId     String
  userId        String
  jobType       String
  language      String
  code          String
  dockerImage   String?
  resourceType  ComputeResourceType @default(CPU)
  gpuType       String?
  scheduledAt   DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  status        ComputeJobStatus    @default(PENDING)
  clusterId     String?
  institutionId String?
  nodeId        String?
  computeHours  Float               @default(0)
  creditsUsed   Float               @default(0)
  output        String?
  error         String?
  metadata      Json                @default("{}")
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  institution   Institution?        @relation(fields: [institutionId], references: [id])
  project       Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([institutionId])
  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
}

model ComputeCredits {
  id            String              @id @default(cuid())
  userId        String?             @unique
  institutionId String?             @unique
  balance       Float               @default(0)
  totalEarned   Float               @default(0)
  totalSpent    Float               @default(0)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  institution   Institution?        @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  user          User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  CreditTransaction[]

  @@index([userId])
  @@index([institutionId])
}

model CreditTransaction {
  id          String                @id @default(cuid())
  creditsId   String
  type        CreditTransactionType
  amount      Float
  description String
  jobId       String?
  metadata    Json                  @default("{}")
  createdAt   DateTime              @default(now())
  credits     ComputeCredits        @relation(fields: [creditsId], references: [id], onDelete: Cascade)

  @@index([creditsId])
  @@index([type])
  @@index([createdAt])
}

model Institution {
  id              String          @id @default(cuid())
  name            String
  domain          String          @unique
  type            String
  clusterEndpoint String?
  gpuCount        Int             @default(0)
  gpuTypes        String[]        @default([])
  utilizationRate Float           @default(0)
  revenueShare    Float           @default(0.70)
  isActive        Boolean         @default(true)
  settings        Json            @default("{}")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  credits         ComputeCredits?
  jobs            ComputeJob[]
  gpuSchedules    GPUSchedule[]   @relation("GPUSchedules")

  @@index([domain])
  @@index([isActive])
}

model GPUSchedule {
  id            String      @id @default(cuid())
  institutionId String
  userId        String?
  startTime     DateTime
  endTime       DateTime
  gpuCount      Int
  gpuType       String?
  purpose       String
  jobId         String?
  createdAt     DateTime    @default(now())
  institution   Institution @relation("GPUSchedules", fields: [institutionId], references: [id], onDelete: Cascade)

  @@index([institutionId])
  @@index([startTime])
  @@index([endTime])
  @@index([userId])
}

model AcademicIntegrity {
  id              String    @id @default(cuid())
  projectId       String    @unique
  examMode        Boolean   @default(false)
  plagiarismScore Float?
  activityLog     Json      @default("[]")
  lockDownUntil   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([examMode])
}

model SessionRecording {
  id           String    @id @default(cuid())
  projectId    String
  sessionName  String
  description  String?
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  duration     Int?
  events       Json      @default("[]")
  playbackData Json?
  isPublic     Boolean   @default(false)
  shareToken   String    @unique
  viewCount    Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([shareToken])
  @@index([isPublic])
}

model CodeTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  language    String
  code        String
  tags        String[] @default([])
  category    String
  isPublic    Boolean  @default(false)
  userId      String?
  usageCount  Int      @default(0)
  rating      Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User?    @relation("CodeTemplates", fields: [userId], references: [id], onDelete: Cascade)

  @@index([language])
  @@index([category])
  @@index([isPublic])
  @@index([userId])
}

model CodeSnippet {
  id         String   @id @default(cuid())
  userId     String
  name       String
  code       String
  language   String
  tags       String[] @default([])
  isFavorite Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation("CodeSnippets", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([language])
  @@index([isFavorite])
}

model CodeReview {
  id         String   @id @default(cuid())
  projectId  String
  filePath   String
  reviewerId String
  status     String   @default("PENDING")
  comments   Json     @default("[]")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewer   User     @relation("CodeReviews", fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([reviewerId])
  @@index([status])
}

model CodeMetric {
  id              String   @id @default(cuid())
  projectId       String
  filePath        String
  language        String
  linesOfCode     Int
  complexity      Float
  maintainability Float
  testCoverage    Float?
  codeQuality     Float
  issues          Json     @default("[]")
  lastAnalyzed    DateTime @default(now())
  createdAt       DateTime @default(now())
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, filePath])
  @@index([projectId])
  @@index([codeQuality])
}

model ShareLink {
  id         String    @id @default(cuid())
  projectId  String?
  fileId     String?
  code       String?
  shortCode  String    @unique
  accessType String    @default("READ_ONLY")
  expiresAt  DateTime?
  viewCount  Int       @default(0)
  maxViews   Int?
  password   String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  project    Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([shortCode])
  @@index([projectId])
}

enum AuthProvider {
  EMAIL
  GITHUB
  GOOGLE
}

enum ProjectVisibility {
  PRIVATE
  PUBLIC
}

enum BranchPushMode {
  AUTO
  MANUAL
  NONE
}

enum DriveSyncMode {
  OFF
  AUTO
  MANUAL
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum RunStatus {
  PENDING
  RUNNING
  SUCCESS
  ERROR
  TIMEOUT
}

enum ComputeJobStatus {
  PENDING
  QUEUED
  SCHEDULED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum ComputeResourceType {
  CPU
  GPU
  MEMORY
}

enum CreditTransactionType {
  EARNED
  SPENT
  REFUNDED
  TRANSFERRED
  DONATED
}
